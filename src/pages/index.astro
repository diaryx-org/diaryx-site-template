---
import DiaryxLayout from "../layouts/DiaryxLayout.astro";
import { getCollection, render } from "astro:content";

// Find the workspace root index: the entry with no part_of and non-empty contents.
// This mirrors diaryx's workspace hierarchy where the root index sits at the top.
const allEntries = await getCollection("diaryx");
const index = allEntries.find(
  (e) => !e.data.part_of && e.data.contents && e.data.contents.length > 0,
) ?? allEntries.find((e) => !e.data.part_of && e.id !== "404")
  ?? allEntries[0];

if (!index) {
  throw new Error("No content entries found. Add markdown files to your content folder.");
}

const { Content, headings } = await render(index);
const frontmatter = index.data;
const trimFirstHeading =
  Array.isArray(headings) &&
  headings.length > 0 &&
  headings[0]?.depth === 1 &&
  headings[0]?.text.trim() === (frontmatter.title ?? "").trim();
---

<DiaryxLayout frontmatter={frontmatter} trimFirstHeading={trimFirstHeading}>
  <Content />
</DiaryxLayout>
